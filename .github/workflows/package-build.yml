name: Package Build (Reusable)

on:
  workflow_call:
    inputs:
      cloudsmith_dest:
        description: "Cloudsmith repo path (test/snapshots/loki/release)"
        required: true
        type: string
      packagecloud_repo:
        description: "Packagecloud repository name"
        required: true
        type: string
    secrets:
      CLOUDSMITH_API_KEY:
        required: false
      PACKAGECLOUD_USER:
        required: false
      PACKAGECLOUD_TOKEN:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
        # Debian (supported)
        - os: debian
          dist: bullseye
          package: deb
          docker_repo: ""
          docker_image: ""
          repack_deb: ""

        - os: debian
          dist: bookworm
          package: deb
          docker_repo: ""
          docker_image: ""
          repack_deb: ""

        - os: debian
          dist: trixie
          package: deb
          docker_repo: "asbru/asbru-cm"
          docker_image: ""
          repack_deb: ""

        # Ubuntu (supported)
        - os: ubuntu
          dist: jammy
          package: deb
          docker_repo: ""
          docker_image: ""
          repack_deb: "yes"

        - os: ubuntu
          dist: noble
          package: deb
          docker_repo: "asbru/asbru-cm"
          docker_image: ""
          repack_deb: "yes"

        # Enterprise Linux
        - os: el
          dist: "8"
          package: rpm
          docker_repo: ""
          docker_image: ""
          repack_deb: ""

        # Linux Mint (21)
        - os: linuxmint
          dist: vanessa
          package: deb
          docker_repo: ""
          docker_image: "ubuntu-jammy"
          repack_deb: ""

        - os: linuxmint
          dist: wilma
          package: deb
          docker_repo: ""
          docker_image: "ubuntu-noble"
          repack_deb: ""

        # Pop!_OS (22.04)
        - os: pop
          dist: jammy
          package: deb
          docker_repo: ""
          docker_image: "ubuntu-jammy"
          repack_deb: "yes"

    env:
      PRODUCT: "asbru-cm"
      OS: ${{ matrix.os }}
      DIST: ${{ matrix.dist }}
      PACKAGE: ${{ matrix.package }}
      DOCKER_REPO: ${{ matrix.docker_repo }}
      DOCKER_IMAGE: ${{ matrix.docker_image }}
      REPACK_DEB: ${{ matrix.repack_deb }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git devscripts debhelper quilt \
            python3 python3-pip python3-setuptools gpgv
          python3 -m pip install --user --upgrade cloudsmith-cli
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Make build script executable
        run: chmod +x ci/build_package.sh

      - name: Build packages
        run: ci/build_package.sh

      - name: Upload build artifacts (for releases)
        if: ${{ github.ref_type == 'tag' }}
        uses: actions/upload-artifact@v4
        with:
          name: "${{ matrix.os }}-${{ matrix.dist }}-${{ matrix.package }}"
          path: build/*

      # Cloudsmith Upload (CLI)
      - name: Upload to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${CLOUDSMITH_API_KEY:-}" ]; then
            echo "CLOUDSMITH_API_KEY not set â€“ skipping Cloudsmith upload."
            exit 0
          fi

          DEST="${{ inputs.cloudsmith_dest }}"

          echo "Uploading to Cloudsmith: asbru-cm/${DEST}/${OS}/${DIST}"
          shopt -s nullglob

          for file in build/*.${PACKAGE}; do
            echo "Pushing $file..."
            cloudsmith push "${PACKAGE}" "asbru-cm/${DEST}/${OS}/${DIST}" "$file"
          done

          if [ "${PACKAGE}" = "deb" ]; then
            for dsc in build/*.dsc; do
              echo "Pushing source package $dsc..."
              cloudsmith push "${PACKAGE}" \
                "asbru-cm/${DEST}/${OS}/${DIST}" \
                "$dsc" \
                --sources-file build/*.debian.tar.*
            done
          fi

      # Packagecloud Upload
      - name: Upload .deb to Packagecloud
        continue-on-error: true
        if: ${{ env.PACKAGE == 'deb' }}
        uses: computology/packagecloud-github-action@v0.8
        env:
          PACKAGECLOUD_USER: ${{ secrets.PACKAGECLOUD_USER }}
          PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
        with:
          package-name: build/*.deb
          packagecloud-username: ${{ env.PACKAGECLOUD_USER }}
          packagecloud-reponame: ${{ inputs.packagecloud_repo }}
          packagecloud-distro: "${{ env.OS }}/${{ env.DIST }}"
          packagecloud-token: ${{ env.PACKAGECLOUD_TOKEN }}

      - name: Upload .rpm to Packagecloud
        continue-on-error: true
        if: ${{ env.PACKAGE == 'rpm' }}
        uses: computology/packagecloud-github-action@v0.8
        env:
          PACKAGECLOUD_USER: ${{ secrets.PACKAGECLOUD_USER }}
          PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
        with:
          package-name: build/*.rpm
          packagecloud-username: ${{ env.PACKAGECLOUD_USER }}
          packagecloud-reponame: ${{ inputs.packagecloud_repo }}
          packagecloud-distro: "${{ env.OS }}/${{ env.DIST }}"
          packagecloud-token: ${{ env.PACKAGECLOUD_TOKEN }}

      - name: Upload .dsc to Packagecloud
        continue-on-error: true
        if: ${{ env.PACKAGE == 'deb' }}
        uses: computology/packagecloud-github-action@v0.8
        env:
          PACKAGECLOUD_USER: ${{ secrets.PACKAGECLOUD_USER }}
          PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
        with:
          package-name: build/*.dsc
          packagecloud-username: ${{ env.PACKAGECLOUD_USER }}
          packagecloud-reponame: ${{ inputs.packagecloud_repo }}
          packagecloud-distro: "${{ env.OS }}/${{ env.DIST }}"
          packagecloud-token: ${{ env.PACKAGECLOUD_TOKEN }}
