name: Build & Deploy Docs

on:
  push:
    branches: [ master, build-test ]
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest

    env:
      GITHUB_API_KEY: ${{ secrets.DOCS_GITHUB_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Install changelog generator
        run: |
          gem install rack -v 1.6.4
          gem install github_changelog_generator

      - name: Generate Changelog
        run: |
          github_changelog_generator \
            --token "${GITHUB_API_KEY}" \
            --release-branch master \
            --user asbru-cm \
            --project asbru-cm \
            --output doc/General/Changelog.md \
            --no-unreleased

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install \
            Click==7.0 \
            future==0.18.2 \
            Jinja2==2.11.1 \
            livereload==2.6.1 \
            lunr==0.5.6 \
            Markdown==3.2.1 \
            MarkupSafe==1.1.1 \
            mkdocs==1.1 \
            mkdocs-material==4.6.3 \
            nltk==3.4.5 \
            Pygments==2.5.2 \
            pymdown-extensions==6.3 \
            PyYAML==5.3 \
            six==1.14.0 \
            tornado==6.0.3

      - name: Build MkDocs site
        run: |
          mkdocs build --clean

      - name: Deploy to GitHub Pages repo (test vs prod)
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"

          if [ "${GITHUB_REF}" = "refs/heads/build-test" ]; then
           GH_REPO="@github.com/asbru-cm-docs/asbrucm-docs-test.github.io.git"
            TARGET_BRANCH="master"   # oder z.B. "build-test"
          else
            GH_REPO="@github.com/asbru-cm-docs/asbrucm-docs.github.io.git"
            TARGET_BRANCH="master"
          fi

          FULL_REPO="https://${GITHUB_API_KEY}${GH_REPO}"

          cd out

          git init
          git remote add origin "$FULL_REPO" || git remote set-url origin "$FULL_REPO"
          git fetch origin || true
          git config user.name "asbrucm-docs"
          git config user.email "travis@asbru-cm.net"

          if git show-ref --verify --quiet "refs/heads/${TARGET_BRANCH}"; then
            git checkout "${TARGET_BRANCH}"
          else
            git checkout -b "${TARGET_BRANCH}"
          fi

          git add -A .
          git commit -m "GH-Pages update by GitHub Actions after $GITHUB_SHA" || echo "Nothing to commit"
          git push -q origin "${TARGET_BRANCH}"
